<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>TesteHTML Publisher Avan√ßado</title>
  <style>
    body{font-family:'Segoe UI',Tahoma,Verdana,sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;display:flex;justify-content:center;align-items:flex-start;padding:32px;}
    .container{background:#fff;border-radius:12px;box-shadow:0 12px 40px rgba(0,0,0,0.10);max-width:900px;width:100%;padding:36px;}
    h1{text-align:center;color:#333;}
    .token-info{background:#fff3cd;color:#856404;padding:12px;border-radius:8px;border:1px solid #ffeaa7;margin-bottom:16px;}
    label{font-weight:bold;color:#333;margin:16px 0 6px;display:block;}
    input,textarea{width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:15px;font-family:monospace;}
    textarea{min-height:200px;resize:vertical;}
    .btn{display:inline-block;margin-top:14px;width:100%;padding:14px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:8px;font-size:16px;font-weight:bold;cursor:pointer;transition:transform .2s;}
    .btn:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,0.2);}
    .btn-secondary{background:#28a745;}
    .btn-danger{background:#dc3545;}
    .btn-group{display:flex;gap:14px;}
    .status{margin-top:18px;padding:12px;border-radius:8px;display:none;}
    .loading{background:#d1ecf1;color:#0c5460;}
    .success{background:#d4edda;color:#155724;}
    .error{background:#f8d7da;color:#721c24;}
    .file-list{margin-top:28px;}
    .file-item{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid #eee;}
    .file-item:last-child{border-bottom:none;}
    .file-link{color:#667eea;text-decoration:none;font-weight:bold;}
    .file-link:hover{text-decoration:underline;}
    .small{font-size:13px;color:#666;margin-top:8px;}
  </style>
</head>
<body>
  <div class="container">
    <h1>üöÄ TesteHTML Publisher PRO</h1>
    <div class="token-info">
      <strong>‚ö° Token via JSONBIN.IO:</strong> Bin <code>68df49ae43b1c97be95893d1</code> ‚Äî pasta <b>testeHTML</b>
    </div>

    <label for="filename">Arquivo (.html):</label>
    <input type="text" id="filename" placeholder="ex: pagina.html">

    <label for="htmlContent">Conte√∫do HTML:</label>
    <textarea id="htmlContent"></textarea>

    <div class="btn-group">
      <button id="newBtn" class="btn btn-secondary" type="button">üÜï Novo</button>
      <button id="saveBtn" class="btn" type="submit" disabled>üíæ Salvar/Atualizar</button>
      <button id="deleteBtn" class="btn btn-danger" type="button" disabled>üóëÔ∏è Apagar</button>
    </div>
    <div id="status" class="status"></div>

    <div class="file-list">
      <h2>Arquivos Existentes</h2>
      <div id="fileList"></div>
      <div class="small">Tempo para deploy/renderizar: ~30s ap√≥s salvar/criar/apagar.</div>
    </div>
  </div>
<script>
const repoOwner='tehewdev',repoName='tehew.space',folder='testeHTML';
const BIN_ID='68df49ae43b1c97be95893d1';
const ACCESS_KEY='$2a$10$f9KK7vSowGnJI5elo/dAPurqjZAJ3bJaWnsinl/caDfgIcNt28kNi';

let token=null, currentSha=null;
const filenameInput=document.getElementById('filename');
const htmlArea=document.getElementById('htmlContent');
const newBtn=document.getElementById('newBtn');
const saveBtn=document.getElementById('saveBtn');
const deleteBtn=document.getElementById('deleteBtn');
const statusDiv=document.getElementById('status');
const fileListDiv=document.getElementById('fileList');
let fileCache={};

function show(msg,cls){statusDiv.innerHTML=msg;statusDiv.className='status '+cls;statusDiv.style.display='block';}
function hide(){statusDiv.style.display='none';}
function sanitize(n){return n.toLowerCase().replace(/[^a-z0-9-_.]/g,'-').replace(/-+/g,'-').replace(/^-|-$/g,'');}

async function loadToken(){
  show('Carregando token...','loading');
  try{
    const res=await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`,{
      headers:{'X-Access-Key':ACCESS_KEY,'X-Bin-Meta':'false'}
    });
    const j=await res.json(); token=j.github_token;
    if(!token) throw 'Token n√£o encontrado.';
    saveBtn.disabled=false;
    await listFiles(); show('Token carregado.','success');
  }catch(e){ show('Erro ao obter token: '+e,'error'); }
}

async function listFiles(){
  try{
    fileListDiv.innerHTML='<small>Carregando arquivos...</small>';
    const url=`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${folder}`;
    const res=await fetch(url,{headers:{'Authorization':'Bearer '+token}});
    if(!res.ok) throw '';
    const items=await res.json();
    fileCache={};
    let html='';
    items.filter(f=>f.name.endsWith('.html')).forEach(f=>{
      fileCache[f.name]=f.sha;
      html+=`
        <div class="file-item">
          <a href="#" class="file-link" data-name="${f.name}">${f.name}</a>
          <button class="btn btn-danger" data-file="${f.name}" type="button">üóëÔ∏è</button>
        </div>`;
    });
    fileListDiv.innerHTML=html||'<small>Nenhum arquivo encontrado.</small>';
    fileListDiv.querySelectorAll('.file-link').forEach(el=>
      el.onclick=e=>{e.preventDefault();loadFile(el.dataset.name);}
    );
    fileListDiv.querySelectorAll('.btn-danger').forEach(el=>
      el.onclick=e=>{e.preventDefault();deleteFile(el.dataset.file);}
    );
  }catch{
    fileListDiv.innerHTML='<span class="error">Falha ao listar arquivos!</span>';
  }
}
async function loadFile(name){
  show('Carregando conte√∫do...','loading');
  const path=`${folder}/${name}`;
  const url=`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${path}`;
  const res=await fetch(url,{headers:{'Authorization':'Bearer '+token}});
  const j=await res.json();
  const html=decodeURIComponent(escape(atob(j.content.replace(/\n/g,''))));
  filenameInput.value=j.name; htmlArea.value=html;
  currentSha=j.sha;
  saveBtn.disabled=false; deleteBtn.disabled=false;
  show('Arquivo carregado.','success');
}
async function saveOrUpdate(){
  const name=sanitize(filenameInput.value.trim());
  const html=htmlArea.value;
  if(!name||!html) return show('Preencha nome e HTML!','error');
  show('Salvando...','loading');
  const path=`${folder}/${name}`;
  const url=`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${path}`;
  // checa se existe para pegar sha:
  let sha=currentSha;
  if(!sha&&fileCache[name]){
    sha=fileCache[name];
  } else if(!sha) {
    // tenta fetch na hora se n√£o est√° cache
    try{
      let get=await fetch(url,{headers:{'Authorization':'Bearer '+token}});
      if(get.ok) {
        let jad=await get.json();
        sha=jad.sha;
      }
    }catch{}
  }
  const data={message:(sha?'Atualiza ':'Cria ')+name,content:btoa(unescape(encodeURIComponent(html))),branch:'main'};
  if(sha) data.sha=sha;
  const res=await fetch(url,{method:'PUT',headers:{'Authorization':'Bearer '+token,'Content-Type':'application/json'},body:JSON.stringify(data)});
  const j=await res.json();
  if(res.ok){ show('Salvo! Deploy ‚âà30s.','success'); currentSha=j.content.sha; await listFiles(); }
  else show('Erro: '+j.message,'error');
}
async function deleteFile(name){
  if(!confirm('Confirma apagar '+name+'?'))return;
  show('Apagando...','loading');
  const path=`${folder}/${name}`;
  const url=`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${path}`;
  let sha=fileCache[name];
  if(!sha){
    // tenta fetch direto
    const res=await fetch(url,{headers:{'Authorization':'Bearer '+token}});
    if(res.ok){const x=await res.json();sha=x.sha;}
  }
  if(!sha) return show('Arquivo n√£o encontrado para apagar.','error');
  const data={message:'Apaga '+name,sha,branch:'main'};
  const res=await fetch(url,{method:'DELETE',headers:{'Authorization':'Bearer '+token,'Content-Type':'application/json'},body:JSON.stringify(data)});
  if(res.ok){
    show('Apagado!','success');
    if(filenameInput.value.trim()===name){filenameInput.value=''; htmlArea.value='';currentSha=null;deleteBtn.disabled=true;}
    await listFiles();
  }else{
    const j=await res.json();
    show('Erro: '+j.message,'error');
  }
}
newBtn.onclick=_=>{
  filenameInput.value=''; htmlArea.value=''; currentSha=null; deleteBtn.disabled=true;
  show('Pronto para criar novo arquivo!','success');
};
saveBtn.onclick=saveOrUpdate;
deleteBtn.onclick=_=>{if(filenameInput.value)deleteFile(filenameInput.value.trim());};
document.getElementById('publishForm').onsubmit=(e)=>{e.preventDefault();saveOrUpdate();};
window.onload=loadToken;
</script>
</body>
</html>
