<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Gemini TTS Diagnóstico Expressivo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --bg-main: #111217;
      --bg-panel: #191b22;
      --text: #fafbfc;
      --text-sec: #b8b7c6;
      --primary: #4f8cff;
      --primary-light: #a5c7ff;
      --secondary: #20cfa3;
      --radius: 18px;
      --shadow: 0 4px 22px 0 rgba(10,16,29,0.20);
      --shadow-inset: 0 2px 7px 0 rgba(30,40,54,0.13) inset;
      --input-bg: #22232a;
      --border: #2a2b34;
      --error: #ff3169;
      --font: 'Inter', Arial, sans-serif;
      --transition: all 0.23s cubic-bezier(.6,.16,.47,.98);
    }
    html, body {
      min-height: 100%;
      margin: 0;
      padding: 0;
      color: var(--text);
      background: var(--bg-main);
      font-family: var(--font);
      letter-spacing:.01em;
      -webkit-user-select: none; user-select: none;
    }
    h1 {
      color: var(--primary);
      text-align: center;
      font-size: 2.1em;
      margin-top: 2.2em;
      font-weight: 800;
      letter-spacing: .04em;
      text-shadow: 0 3px 14px rgba(79,140,255,0.09);
    }
    .container {
      max-width: 570px;
      margin: 2.2em auto;
      padding: 2.4em 1.3em 1.7em 1.3em;
      background: var(--bg-panel);
      border-radius: var(--radius);
      box-shadow: var(--shadow), var(--shadow-inset);
      border: 1.5px solid var(--border);
      transition: var(--transition);
    }
    section {
      margin-top: 2.5em;
    }
    label {
      font-size: 1.08em;
      font-weight: 520;
      color: var(--text-sec);
      display: block;
      margin: .95em 0 .27em 0;
      letter-spacing: .01em;
    }
    input, textarea, select, button {
      font-size: 1em;
      width: 100%;
      margin-top: .43em;
      border-radius: 9px;
      border: 1.3px solid var(--border);
      background: var(--input-bg);
      color: var(--text);
      padding: .77em 1em;
      box-sizing: border-box;
      outline: none;
      transition: var(--transition);
    }
    input:focus, textarea:focus, select:focus {
      border: 1.5px solid var(--primary-light);
      background: #20222a;
    }
    textarea {
      resize: vertical;
      min-height: 64px;
      box-shadow: 0 1.5px 11px 0 rgba(34,40,70,0.02);
      font-size: 1.08em;
    }
    select {
      background: linear-gradient(90deg,#21232d 50%,#23253b 100%);
      font-weight: 500;
      cursor: pointer;
    }
    button {
      background: linear-gradient(90deg, var(--primary) 48%, var(--secondary) 100%);
      color: var(--text);
      border: none;
      font-weight: 700;
      cursor: pointer;
      margin-top: 1.2em;
      padding: 1.07em 1em;
      box-shadow: 0 1.5px 10px 0 rgba(79,140,255,.070);
      transition: var(--transition);
    }
    button:disabled {
      background: #232632;
      color: #8598b5;
      opacity:0.75;
      cursor: not-allowed;
    }
    .audio-box {
      margin-top: 1.1em;
      background: #10121b;
      padding: 1.35em 1.1em 1.1em 1.1em;
      border-radius: 10px;
      border: 1.3px solid var(--border);
      box-shadow: var(--shadow-inset);
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      animation: fadeinbox .5s cubic-bezier(.45,1.5,.63,.99);
    }
    @keyframes fadeinbox {
      from {opacity:0;transform:scale(.98);}
      to   {opacity:1;transform:scale(1);}
    }
    .audio-box audio { width:100%; min-width:180px; outline:none; margin:0 0 .5em 0;}
    .audio-box a {
      margin-top:.42em;
      font-size:.98em;
      color: var(--secondary);
      text-decoration: underline dotted #178565 2px;
      font-weight: 600;
      letter-spacing: .01em;
    }
    .er {
      color: var(--error);
      margin-top: .7em;
      font-size: 1.01em;
      font-weight: 500;
      letter-spacing: .01em;
      text-shadow: 0 2px 8px #221;
    }
    #apiInput {margin:0 0 .7em 0;}
    /* Mobile  */
    @media (max-width:700px) {
      .container {padding: 1.2em .2em 1.2em .2em;}
      h1 {font-size:1.28em;}
    }
    /* Scrollbars */
    ::-webkit-scrollbar {width:7px;background:#161821;}
    ::-webkit-scrollbar-thumb {background:#24252f;border-radius:8px;}
  </style>
</head>
<body>
  <h1>Gemini 2.5 — Diagnóstico TTS Expressivo</h1>
  <div class="container">
    <input id="apiInput" type="text" placeholder="Cole sua chave Gemini API">
    <button id="setApiKey">Salvar chave</button>

    <section>
      <label for="chatInput">Texto comum:</label>
      <textarea id="chatInput" placeholder="Digite aqui..."></textarea>
      <button id="chatSendBtn">Aprimorar p/ TTS</button>
      <textarea id="chatOutput" placeholder="Pronto para Gemini TTS" readonly style="margin-top:.72em;"></textarea>
      <div id="chatErrorMessage" class="er" style="display:none"></div>
    </section>

    <section>
      <label for="ttsInput">Texto para áudio:</label>
      <textarea id="ttsInput" placeholder="Cole aqui..."></textarea>
      <label for="voz">Voz:</label>
      <select id="voz">
      <option value="Achernar">Achernar (feminina)</option>
      <option value="Achird">Achird (masculina)</option>
      <option value="Algenib">Algenib (masculina)</option>
      <option value="Algieba">Algieba (masculina)</option>
      <option value="Alnilam">Alnilam (masculina)</option>
      <option value="Aoede">Aoede (feminina)</option>
      <option value="Autonoe">Autonoe (feminina)</option>
      <option value="Callirrhoe">Callirrhoe (feminina)</option>
      <option value="Charon">Charon (masculina)</option>
      <option value="Despina">Despina (feminina)</option>
      <option value="Enceladus">Enceladus (masculina)</option>
      <option value="Erinome">Erinome (feminina)</option>
      <option value="Fenrir">Fenrir (masculina)</option>
      <option value="Gacrux">Gacrux (feminina)</option>
      <option value="Iapetus">Iapetus (masculina)</option>
      <option value="Kore">Kore (feminina)</option>
      <option value="Laomedeia">Laomedeia (feminina)</option>
      <option value="Leda">Leda (feminina)</option>
      <option value="Orus">Orus (masculina)</option>
      <option value="Puck">Puck (masculina)</option>
      <option value="Pulcherrima">Pulcherrima (feminina)</option>
      <option value="Rasalgethi">Rasalgethi (masculina)</option>
      <option value="Sadachbia">Sadachbia (feminina)</option>
      <option value="Sadaltager">Sadaltager (masculina)</option>
      <option value="Schedar">Schedar (masculina)</option>
      <option value="Sulafat">Sulafat (feminina)</option>
      <option value="Umbriel">Umbriel (masculina)</option>
      <option value="Vindemiatrix">Vindemiatrix (feminina)</option>
      <option value="Zephyr">Zephyr (feminina)</option>
      <option value="Zubenelgenubi">Zubenelgenubi (masculina)</option>
      </select>
      <button id="ttsSendBtn">Gerar áudio TTS</button>
      <div id="ttsErrorMessage" class="er" style="display:none"></div>
      <div id="ttsOutput"></div>
    </section>
  </div>
<script>
let API_KEY = localStorage.getItem('gemini_apikey') || '';
function ensureApiKey() {
  API_KEY = localStorage.getItem('gemini_apikey') || '';
  if(!API_KEY || API_KEY.length<20) {
    alert('Informe/salve uma chave Gemini!'); document.getElementById('apiInput').focus();
    throw "Chave não definida";
  }
}
document.getElementById('setApiKey').onclick = ()=>{
  const key = document.getElementById('apiInput').value.trim();
  if (key.length>20) {
    localStorage.setItem('gemini_apikey', key);
    API_KEY = key; alert('Chave salva!');
  } else {
    alert('Chave inválida!'); document.getElementById('apiInput').focus();
  }
};

const ttsManual = `
MODELO EXPRESSIVO TTS — SIGA:
- Interprete/emule tom de voz: voz calma, autoritária, emocionada, sussurrada, etc.
- Use pausas e ritmo conforme instruções (“fale lentamente”, “hesitação”, “rápido...”).
- Expresse emoções: alegria, tristeza, raiva, teatralidade, entusiasmo, etc.
- Adote estilos: falar com bebê, narrador épico, apresentador de TV, teatral, ASMR, etc.
- Não ignore sons não-verbais: (SUSPIRO), (BEIJO_NO_AR), (RISADA_LEVE), (RONRONO), etc.
- Use SEMPRE marcação para efeitos/emoções/estilos, sem explicação nem texto extra.
EXEMPLOS:
(SUSPIRO) Oi, meu amorzinho...
(VOZ_AGUDINHA) Quem é? (BEIJO_NO_AR)
(TOM_CONSPIRATÓRIO) Psst... te conto um segredo... (SACOLA_BALANÇANDO)
`; // Compacto 

async function aprimorarFraseTTS(frase) {
  ensureApiKey();
  const prompt = ttsManual + "\n\n" + frase;
  const payload = {
    contents: [
      { role: "user", parts: [ { text: prompt } ] }
    ]
  };
  try {
    const r = await fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent?key=" + API_KEY, {
      method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)
    });
    const d = await r.json();
    if (!r.ok) return {error: d.error?.message || 'Erro Gemini'};
    let out = "";
    if (d.candidates?.[0]?.content?.parts)
      for(const p of d.candidates[0].content.parts) if(p.text) out += p.text+"\n";
    return { text: out.trim() };
  } catch(e){ return { error: e.message||"Erro inesperado"};}
}
document.getElementById("chatSendBtn").onclick = async () => {
  let inp = document.getElementById("chatInput").value.trim();
  let chatError = document.getElementById("chatErrorMessage");
  chatError.style.display = "none";
  if(!inp) return;
  document.getElementById("chatSendBtn").disabled = true;
  try {
    let r = await aprimorarFraseTTS(inp);
    if(r.error){
      chatError.textContent = r.error; chatError.style.display="block";
      document.getElementById("chatOutput").value = "";
    } else {
      document.getElementById("chatOutput").value = r.text;
      document.getElementById("ttsInput").value = r.text;
    }
  } finally { document.getElementById("chatSendBtn").disabled = false;}
};

function convertRawL16ToWav(rawL16,s=24000,c=1,b=16){
  const h = new ArrayBuffer(44), v=new DataView(h);
  let ba=c*(b/8), br=s*ba, dl=rawL16.length;
  function st(x,i){for(let j=0;j<x.length;j++)v.setUint8(i+j,x.charCodeAt(j));}
  st('RIFF',0); v.setUint32(4,36+dl,true); st('WAVE',8); st('fmt ',12);
  v.setUint32(16,16,true); v.setUint16(20,1,true); v.setUint16(22,c,true);
  v.setUint32(24,s,true); v.setUint32(28,br,true); v.setUint16(32,ba,true); v.setUint16(34,b,true); st('data',36); v.setUint32(40,dl,true);
  const w=new Uint8Array(44+dl); w.set(new Uint8Array(h),0); w.set(rawL16,44); return w;
}
async function gerarAudioTTS(txt, voz) {
  ensureApiKey();
  const payload = {
    contents: [{role:"user",parts:[{text:txt}]}],
    generationConfig:{
      responseModalities:["AUDIO"],
      speechConfig: {voiceConfig:{prebuiltVoiceConfig:{voiceName:voz}}}
    }
  };
  try {
    const r=await fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=" + API_KEY, {
      method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)
    });
    const d=await r.json();
    if(!r.ok) return { error: d.error?.message||"Erro Gemini"};
    let base64 = "", mimetype="audio/wav";
    if(d.candidates?.[0]?.content?.parts)
      for(const p of d.candidates[0].content.parts){
        if(p.inlineData?.data) base64 = p.inlineData.data;
        if(p.inlineData?.mimeType) mimetype = p.inlineData.mimeType;
      }
    if(!base64)return { error: 'API não retornou áudio.' };
    const bin=atob(base64), bytes=new Uint8Array([...bin].map(c=>c.charCodeAt(0)));
    let wavBytes = mimetype && mimetype.toLowerCase().startsWith('audio/l')
      ? convertRawL16ToWav(bytes) : bytes;
    let blob = new Blob([wavBytes],{type:'audio/wav'}), url=URL.createObjectURL(blob);
    return { url };
  } catch(e){ return { error: e.message||"Erro inesperado"};}
}
document.getElementById("ttsSendBtn").onclick = async () => {
  let txt = document.getElementById("ttsInput").value.trim();
  let voz = document.getElementById("voz").value;
  let ttsError = document.getElementById("ttsErrorMessage");
  ttsError.style.display = "none";
  if(!txt) return;
  document.getElementById("ttsSendBtn").disabled = true;
  try {
    let r = await gerarAudioTTS(txt, voz);
    if(r.error){
      ttsError.textContent=r.error; ttsError.style.display="block";
      document.getElementById("ttsOutput").innerHTML = "";
    } else {
      document.getElementById("ttsOutput").innerHTML =
        `<div class="audio-box"><audio controls src="${r.url}"></audio>
         <a href="${r.url}" download="voz-gemini.wav">Baixar Áudio</a></div>`;
    }
  } finally { document.getElementById("ttsSendBtn").disabled = false;}
};
</script>

</body>
</html>