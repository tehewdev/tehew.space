<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TesteHTML Publisher Corrigido</title>
  <!-- CodeMirror CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/dracula.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldgutter.min.css">
  <style>
    body {background: linear-gradient(135deg,#667eea,#764ba2); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; min-height:100vh; margin:0; display:flex; align-items:center; justify-content:center;}
    .container {background:#fff; padding:28px; max-width:980px; width:100%; border-radius:16px; box-shadow:0 12px 32px rgba(0,0,0,0.12);}
    h1 {margin:0 0 18px;color:#5964f1;text-align:center;}
    .input-group {margin: 12px 0;}
    .input-group label {font-weight: 500;}
    input[type=text] {width:100%;padding:10px;margin:5px 0 0;border-radius:8px;border:1.5px solid #bbb;}
    .info-bar {display:flex;gap:16px;justify-content:center;margin:15px 0;}
    .info {background:#f2f3ff;padding:6px 12px;border-radius:8px;font-size:14px;}
    .editor-toolbar {display:flex;gap:8px;margin:8px 0;}
    .btn {padding:9px 17px;border:none;border-radius:8px;font-weight:600; cursor:pointer;}
    .btn-primary {background: linear-gradient(135deg,#667eea,#764ba2); color:#fff;}
    .btn-secondary {background:#eef1ff;color:#667eea;}
    .status {margin-top:18px;padding:11px 15px;border-radius:8px;display:none;}
    .status.success {background:#dff0d8;color:#3c763d;}
    .status.error {background:#f2dede;color:#a94442;}
    .file-list {background:#f8f9fa;padding:16px;border-radius:10px;margin-top:22px;}
    .file-item {display:flex;justify-content:space-between;background:#fff;border:1px solid #eee;padding:10px 14px;margin-top:8px;border-radius:7px;}
    .file-item a {text-decoration:none;color:#667eea;font-weight:600;}
    .file-actions button{margin-left:10px;}
    @media (max-width:700px){
      .container{padding:14px;}
      .editor-toolbar{flex-direction:column;}
    }
    .CodeMirror {height:auto; min-height:360px;}
  </style>
</head>
<body>
  <div class="container">
    <h1>🚀 TesteHTML Publisher Corrigido</h1>
    <div class="info-bar">
      <div class="info">Linhas: <span id="lineCount">0</span></div>
      <div class="info">Caracteres: <span id="charCount">0</span></div>
      <div class="info">Tamanho: <span id="sizeCount">0KB</span></div>
    </div>
    <div class="input-group">
      <label>Nome do arquivo (.html):</label>
      <input type="text" id="filename" value="minha-pagina.html">
    </div>
    <div>
      <div class="editor-toolbar">
        <button id="formatBtn" class="btn btn-secondary">Formatar</button>
        <button id="validateBtn" class="btn btn-secondary">Validar</button>
        <button id="clearBtn" class="btn btn-secondary">Limpar</button>
        <button id="publishBtn" class="btn btn-primary">🚀 Publicar no GitHub</button>
        <select id="themeSelector" class="btn btn-secondary">
          <option value="default">Light</option>
          <option value="dracula" selected>Dracula</option>
        </select>
      </div>
      <textarea id="htmlContent" spellcheck="false">
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Exemplo</title>
</head>
<body>
  <h1>Publicação Dinâmica!</h1>
  <p>Edite aqui seu HTML e publique via GitHub!</p>
</body>
</html>
      </textarea>
    </div>
    <div id="status" class="status"></div>
    <div class="file-list">
      <b>Arquivos publicados</b>
      <div id="fileList">Carregando...</div>
    </div>
  </div>
  <!-- CodeMirror Scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/css/css.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/htmlmixed/htmlmixed.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldgutter.min.js"></script>
  <script>
    // --- CONFIG (adapte a busca de token para seu ambiente seguro no backend) ---
    const config = {
      repoOwner: 'tehewdev',
      repoName: 'tehew.space',
      folder: 'testeHTML',
      previewBaseUrl: 'https://tehew.space',
      // NÃO exponha seu accessKey/token em prod!
      accessKey: '' // deixe em branco e busque via backend seguro
    };
    let token = null;

    // --- COMPORTAMENTO DO EDITOR ---
    const editor = CodeMirror.fromTextArea(document.getElementById('htmlContent'), {
      mode: "htmlmixed",
      theme: "dracula",
      lineNumbers: true,
      lineWrapping: true,
      foldGutter: true,
      gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"]
    });

    function updateEditorStats() {
      const content = editor.getValue();
      document.getElementById('lineCount').textContent = editor.lineCount();
      document.getElementById('charCount').textContent = content.length;
      document.getElementById('sizeCount').textContent = (new Blob([content]).size / 1024).toFixed(2) + " KB";
    }
    editor.on("change", updateEditorStats);
    updateEditorStats();

    document.getElementById('themeSelector').addEventListener("change", function() {
      editor.setOption("theme", this.value);
    });

    // --- FORMATAÇÃO & VALIDAÇÃO ---
    document.getElementById('formatBtn').onclick = () => {
      let content = editor.getValue();
      let pretty = content.replace(/>\s*</g, '>\n<');
      editor.setValue(pretty.trim());
      updateEditorStats();
      setStatus("Formatado com sucesso.", "success");
    };

    document.getElementById('validateBtn').onclick = () => {
      let content = editor.getValue();
      let msg = simpleValidateHTML(content);
      setStatus(msg.ok ? "✅ HTML parece válido!" : msg.error, msg.ok ? "success" : "error");
    };

    function simpleValidateHTML(content) {
      if (!content.match(/<!DOCTYPE/i)) return {ok:false, error:"Faltando <!DOCTYPE>"};
      if (!content.match(/<html/i)) return {ok:false, error:"Faltando <html>"};
      if (!content.match(/<body/i)) return {ok:false, error:"Faltando <body>"};
      // Validação simples de fechamento de tags
      let tags = [], exp, m, regex = /<\/?([a-zA-Z0-9]+)(\s[^>]*)?>/g;
      while ((m = regex.exec(content)) != null) {
        if (m[0][1] !== '/') tags.push(m[1]);
        else if (!(exp = tags.pop()) || exp !== m[1]) return {ok:false, error:`Problema nas tags: ${m[0]}`};
      }
      if (tags.length) return {ok:false, error:`Tags abertas sem fechamento: ${tags.join(', ')}`};
      return {ok:true};
    }

    document.getElementById('clearBtn').onclick = () => {
      if (confirm("Limpar editor?")) editor.setValue("");
      updateEditorStats();
    };

    // --- PUBLICAÇÃO (adaptar para ambiente seguro) ---
    document.getElementById('publishBtn').onclick = async function() {
      if (!token) return setStatus('Token não carregado.', 'error');
      const filename = document.getElementById('filename').value.trim();
      const content = editor.getValue();
      if (!filename || !content) return setStatus('Preencha tudo', 'error');
      setStatus('⏳ Publicando...');
      try {
        // OBTENHA O TOKEN DE MANEIRA SEGURA (NUNCA deixe hardcoded)
        const url = "https://api.github.com/repos/" + config.repoOwner + "/" + config.repoName + "/contents/" + config.folder + "/" + filename;
        const body = {
          message: "Publicando " + filename,
          content: btoa(unescape(encodeURIComponent(content))),
          branch: "main"
        };
        const resp = await fetch(url, {
          method: "PUT",
          headers: {
            "Authorization": "Bearer " + token,
            "Accept": "application/vnd.github+json",
            "Content-Type": "application/json"
          },
          body: JSON.stringify(body)
        });
        const res = await resp.json();
        if (!resp.ok) throw new Error(res.message);
        setStatus('✅ Publicado! <a href="' + config.previewBaseUrl + '/' + config.folder + '/' + encodeURIComponent(filename) + '" target="_blank">Ver página</a>', 'success');
        listFiles();
      } catch (e) {
        setStatus("Erro: " + e.message, "error");
      }
    };

    // --- LISTAGEM DE ARQUIVOS (require token válido) ---
    async function listFiles() {
      if (!token) return;
      try {
        const url = "https://api.github.com/repos/" + config.repoOwner + "/" + config.repoName + "/contents/" + config.folder + "?ref=main";
        const r = await fetch(url, {headers: {"Authorization": "Bearer " + token}});
        const files = await r.json();
        if (!Array.isArray(files)) throw new Error("Falha resposta");
        const html = files.filter(f=>f.name.endsWith('.html'))
          .map(f=>`<div class='file-item'><a href='${config.previewBaseUrl}/${config.folder}/${f.name}' target='_blank'>${f.name}</a></div>`)
          .join('');
        document.getElementById('fileList').innerHTML = html || "Nenhum arquivo.";
      } catch (e) {
        document.getElementById('fileList').innerHTML = "Erro: " + e.message;
      }
    }

    // --- STATUS ---
    function setStatus(msg, type) {
      const s = document.getElementById('status');
      s.innerHTML = msg;
      s.className = "status " + (type || "");
      s.style.display = "block";
    }

    // --- LOAD TOKEN VIA BACKEND (SEGURANÇA) ---
    async function loadToken() {
      // EXEMPLO: busque do backend, ou API privada. NÃO EXIBA tokens no frontend!
      // token = (await fetch('/minha-api-segura')).text();
      // Aqui, exibe aviso apenas. Substitua pela lógica real de busca do token.
      setStatus("Token não carregado. Adapte a busca do token para o seu ambiente seguro!", "error");
    }

    // --- Inicialização ---
    loadToken();
    listFiles();
  </script>
</body>
</html>
