<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Gemini TTS DiagnÃ³stico WAV - Completo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
  <h1>Gemini TTS DiagnÃ³stico WAV (Nov/2025)</h1>
  
  <h2>Chat para Aprimorar Frases TTS</h2>
  <div id="chatHistory" style="border:1px solid #bbb;min-height:60px;padding:6px 8px;margin-bottom:5px;"></div>
  <textarea id="chatInput" placeholder="Digite uma frase para aprimorar e gerar Ã¡udio..." rows="3" cols="60"></textarea><br>
  <button type="button" id="sendChat">Aprimorar Frase (texto)</button>
  <button type="button" id="insertTTS">Usar Frase Aprimorada no TTS</button>
  <div id="chatErrorMessage" style="color:red;font-weight:bold;"></div>
  <hr>

  <h2>DiagnÃ³stico Gemini TTS</h2>
  <label for="texto">Texto para Ãudio:</label><br>
  <textarea id="texto" rows="3" cols="60"></textarea><br>
  <label for="modelo">Modelo TTS:</label>
  <select id="modelo">
    <option value="gemini-2.5-flash-tts">Gemini 2.5 Flash TTS (stable)</option>
    <option value="gemini-2.5-flash-preview-tts">Gemini 2.5 Flash TTS (preview)</option>
  </select>
  <br>
  <label for="voz">Voz:</label>
  <select id="voz">
    <option>Zephyr</option>
    <option>Orus</option>
    <option>Kore</option>
    <option>Achernar</option>
    <option>Aoede</option>
    <option>Autonoe</option>
    <option>Callirrhoe</option>
    <option>Despina</option>
    <option>Erinome</option>
    <option>Gacrux</option>
    <option>Laomedeia</option>
    <option>Leda</option>
    <option>Pulcherrima</option>
    <option>Sulafat</option>
    <option>Vindemiatrix</option>
    <option>Achird</option>
    <option>Algenib</option>
    <option>Algieba</option>
    <option>Alnilam</option>
    <option>Charon</option>
    <option>Enceladus</option>
    <option>Fenrir</option>
    <option>Iapetus</option>
    <option>Puck</option>
    <option>Rasalgethi</option>
    <option>Sadachbia</option>
    <option>Sadaltager</option>
    <option>Schedar</option>
    <option>Umbriel</option>
    <option>Zubenelgenubi</option>
  </select>
  <br>
  <button id="ttsBtn">Gerar Ãudio</button>
  <div id="msg" style="color:red;font-weight:bold;"></div>
  <div id="audioResult"></div>
  <div id="hex-debug"></div>

<script>
// VARIÃVEIS BÃSICAS
let API_KEY = localStorage.getItem('gemini_apikey') || '';
function askApiKey(){
  let key = prompt("Insira sua chave da API Gemini:");
  if(key){key=key.trim();API_KEY=key;localStorage.setItem('gemini_apikey', key);}
}
if(!API_KEY) askApiKey();

const ttsManual = `
ğŸ™ï¸ 1. Tom de Voz: â€œvoz calma e reconfortanteâ€, â€œtom autoritÃ¡rio e diretoâ€, â€œvoz trÃªmula e emocionadaâ€, etc.
ğŸ•“ 2. Ritmo: â€œfale lentamenteâ€, â€œacelerado e nervosoâ€, â€œcom hesitaÃ§Ã£o entre as palavrasâ€...
ğŸ˜®â€ğŸ’¨ 3. EmoÃ§Ãµes: â€œalegria contagianteâ€, â€œvoz embargada de tristezaâ€, â€œfalando com raiva contidaâ€...
ğŸ­ 4. Estilo: â€œfalando com um bebÃªâ€, â€œimitando apresentador culinÃ¡rioâ€, â€œnarrador Ã©picoâ€, â€œsensualidade exageradaâ€...
ğŸ”‰ 5. Sons/Efeitos: marcadores como (SUSPIRO), (PAUSA), (RISADA), (RONRONO)... simulam efeitos nÃ£o-verbais e pausas.
Use exemplos e marcadores para TTS expressivo conforme desejar.
`;

const systemPromptTTSManual = `VocÃª Ã© um assistente especializado em criar prompts para Texto-para-Fala (TTS) expressivo. Aprimore frases conforme o manual abaixo, sÃ³ com exemplos prontos para uso, sempre em portuguÃªs do Brasil.
--- MANUAL ---
${ttsManual}
--- FIM DO MANUAL ---
`;

let lastGeminiChat = "";

// CHAT EXPRESSIVO usando gemini-2.5-flash-lite (TEXTO)
document.getElementById('sendChat').onclick = async function() {
  const chatInput = document.getElementById('chatInput');
  const chatErrorMessageDiv = document.getElementById('chatErrorMessage');
  const chatHistoryDiv = document.getElementById('chatHistory');
  const userMsg = chatInput.value.trim();
  chatErrorMessageDiv.textContent = '';
  if (!API_KEY) { askApiKey(); if(!API_KEY)return;}
  if (!userMsg) { chatErrorMessageDiv.textContent = "Digite uma frase para aprimorar."; return; }
  chatHistoryDiv.innerHTML += `<div><b style="color:#4285f4">VocÃª:</b> ${userMsg}</div>`;
  chatInput.value = '';
  document.getElementById('sendChat').disabled = true;
  try {
    const payload = {
      contents: [
        { role: "system", parts: [{ text: systemPromptTTSManual }] },
        { role: "user", parts: [{ text: userMsg }] }
      ],
      generationConfig: {
        responseModalities: ["TEXT"]
      }
    };
    const resp = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent?key='+API_KEY, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const data = await resp.json();
    let answer = '';
    if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts)
      for (const p of data.candidates[0].content.parts)
        if (p.text) answer += p.text;
    if (answer) {
      lastGeminiChat = answer;
      chatHistoryDiv.innerHTML += `<div><b style="color:#197e1e">Assistente:</b> ${answer}</div>`;
    } else throw new Error('Resposta vazia ou erro no Gemini');
  } catch (e) {
    chatErrorMessageDiv.textContent = "Falha no Gemini: " + (e.message || e);
  } finally {
    document.getElementById('sendChat').disabled = false;
  }
};
document.getElementById('insertTTS').onclick = function() {
  if (lastGeminiChat) {
    document.getElementById('texto').value = lastGeminiChat;
    window.scrollTo({top:0,behavior:'smooth'});
  }
};

// ÃUDIO (TTS) usando gemini-2.5-flash-tts
document.getElementById('ttsBtn').onclick = async function() {
  document.getElementById('audioResult').innerHTML = '';
  document.getElementById('hex-debug').innerHTML = '';
  const texto = document.getElementById('texto').value.trim();
  const modelo = document.getElementById('modelo').value;
  const voz = document.getElementById('voz').value;
  const msgbox = document.getElementById('msg');
  msgbox.textContent='';
  if(!API_KEY){askApiKey();if(!API_KEY)return;}
  if(!texto){msgbox.textContent='Digite algum texto.';return;}
  let speechConfig = {voiceConfig:{prebuiltVoiceConfig:{voiceName:voz}}};
  const payload={
    contents:[{role:"user",parts:[{text:texto}]}],
    generationConfig:{responseModalities:["AUDIO"],speechConfig}
  };
  document.getElementById('ttsBtn').disabled=true;
  msgbox.textContent = 'Gerando... Aguarde.';
  try {
    const resp=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelo}:generateContent?key=${API_KEY}`,{
      method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)
    });
    const data=await resp.json();
    if(!resp.ok) throw new Error((data.error && data.error.message)||'Falha desconhecida API Gemini');
    let base64='',mimetype='';
    if(data.candidates&&data.candidates[0]&&data.candidates[0].content&&data.candidates[0].content.parts)
      for(const p of data.candidates[0].content.parts)
        if(p.inlineData&&p.inlineData.data){
          base64=p.inlineData.data; mimetype=p.inlineData.mimeType||'audio/wav';
        }
    if(!base64){msgbox.textContent='API nÃ£o retornou Ã¡udio.';return;}
    function b64ToBytes(b){const bin=atob(b);return Uint8Array.from([...bin].map(c=>c.charCodeAt(0)));}
    let audioBytes = b64ToBytes(base64);
    document.getElementById('hex-debug').innerText="HEX PCM (primeiros 64 bytes):\n" + audioBytes.slice(0,64).join(' ');
    let blob = new Blob([audioBytes],{type:'audio/wav'});
    const url = URL.createObjectURL(blob);
    document.getElementById('audioResult').innerHTML = `
      <b>Formato Gemini:</b> ${mimetype}<br>
      <b>Tamanho:</b> ${audioBytes.length} bytes<br>
      <audio controls src="${url}" style="display:block"></audio>
      <a download="voz-gemini-tts.wav" href="${url}">Baixar Ãudio</a>
      <div style="margin-top:.8em;color:#4caf50">âœ“ Pronto!</div>
    `;
    msgbox.textContent = '';
  } catch(e) {
    msgbox.textContent = 'Falha ao gerar Ã¡udio: ' + (e.message||e);
    document.getElementById('audioResult').innerHTML='';
    document.getElementById('hex-debug').innerHTML='';
  } finally {
    document.getElementById('ttsBtn').disabled=false;
  }
};
</script>
</body>
</html>